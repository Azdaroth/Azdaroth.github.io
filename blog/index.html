
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert</title>
  <meta name="author" content="Karol Galanciak">

  
  <meta name="description" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">

  
  <meta name="keywords" content="Ruby on Rails, RabbitMQ, Kafka, Microservices, Distributed Systems, Architecture, Ember.js, PostgreSQL, JavaScript, Consulting, MVP, post MVP, legacy apps">

  
  

  <meta property="og:title" value="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" />
  <meta property="og:description" value="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" />
  <meta property="og:url" value="https://karolgalanciak.com/blog/index.html" />
  <meta property="og:type" content="website" />
  
  <meta property="og:site_name" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert"/>
  <meta property="og:locale" content="en_US" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@Azdaroth">
  <meta name="twitter:creator" content="@Azdaroth">
  <meta name="twitter:title" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">
  <meta name="twitter:url" content="">
  <meta name="twitter:description" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://karolgalanciak.com/blog">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" type="application/atom+xml">
  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type":"WebPage",
        "@id": "https://karolgalanciak.com/blog"
      },
      "headline": "Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert",
        "image": {
        "@type": "ImageObject",
        "url": "",
        "height": 640,
        "width": 1024
      },
      "datePublished": "",
      "dateModified": "2019-09-08",
      "author": {
        "@type": "Person",
        "name": "Karol Galanciak"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Karol Galanciak",
        "logo": {
          "@type": "ImageObject",
          "url": "https://karolgalanciak.com/images/me_formal.jpg",
          "width": 600,
          "height": 60
        }
      },
      "description": "Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert",
      "keywords": "Ruby on Rails, RabbitMQ, Kafka, Microservices, Distributed Systems, Architecture, Ember.js, PostgreSQL, JavaScript, Consulting, MVP, post MVP, legacy apps"
    }
  </script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42570582-1', 'auto');
    ga('send', 'pageview');
    ga('set', 'anonymizeIp', true);
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:karolgalanciak.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">About Me</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/test-driven-ember">Test-Driven Ember Book</a></li>
  <li><a href="/presentations">Presentations</a></li>
  <li><a href="/publications">Publications</a></li>
  <li><a href="/open-source">Open Source</a></li>
  <li><a href="/privacy-policy">Privacy Policy</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/">Durable Sidekiq Jobs: How to Maximize Reliability of Sidekiq and Redis</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-08-18T20:00:00+02:00" pubdate data-updated="true">Aug 18<span>th</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Sidekiq</strong> is one of the most popular (if not the most popular one) background job framework in Ruby world, which is not a big surprise: it allows to achieve a decent throughput, is stable and well-maintained, has some great features (including also all the gems extending its built-in functionality) and is easy to get started with. It seems like you could simply install <strong>Redis</strong>, add <strong>Sidekiq</strong> to your application and you are good to go!</p>

<p>That would work if you didn&rsquo;t have any <strong>business-critical background jobs</strong> where <strong>reliability</strong> doesn&rsquo;t matter that much. However, if you cannot afford to <strong>lose jobs</strong> every now and then, there are some things that are absolutely critical to review in your configuration and infrastructure.</p>

<h2>How can you lose a Sidekiq job?</h2>

<p>There are multiple scenarios of how you can lose a Sidekiq job without preventive measures. Some of them are quite obvious; some of them are not.</p>

<p>One obvious way would be having Redis down and trying to enqueue a job. This one is pretty intuitive as there is no way of pushing something to Redis if there is no connection to Redis in the first place. From the less obvious scenarios, what is going to happen when Redis crashes while processing a job, due to, e.g., Out Of Memory exception? In &ldquo;standard&rdquo; Sidekiq (although not in Sidekiq Pro), processing a job means that the data is dequeued from Redis and if the worker is interrupted and killed, the job will be lost.</p>

<p>To make the matter worse, there are even more ways how to lose jobs. Imagine that Redis has been working just fine so far, there are some jobs enqueued to be processed in the future, nothing is getting processed at the moment and&hellip; the server gets restarted. Depending on your setup and how much data is stored in memory before it gets &ldquo;persisted&rdquo;, it might turn out that all (or at least some of them) the enqueued jobs are lost!</p>

<p>As terrible as it sounds, there are some relatively quick fixes to these problems. Even though it might be still possible to lose jobs under <a href="https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781783280216/1/ch01lvl1sec16/dealing-with-aof-corruption-intermediate">extreme circumstances</a>, these solutions will significantly minimize the likelihood of critical problems.</p>

<h2>Sidekiq Pro and its reliability features</h2>

<p>The very first thing that would be worth doing would be buying a license for <a href="https://sidekiq.org/products/pro.html">Sidekiq Pro</a> which is a low hanging-fruit, and you can quickly add it to your applications.</p>

<p>Sidekiq Pro, unlike &ldquo;standard&rdquo; Sidekiq, offers extra server reliability by using <a href="https://redis.io/commands/rpoplpush">Redis&rsquo;s RPOPLPUSH</a>. Thanks to that, the job is not entirely removed from Redis once it starts being processed. Rather, it is atomically moved to &ldquo;processing list&rdquo; and is removed from there only after it&rsquo;s processed. In that sense, we can be confident that if the job ended up in Redis, it would almost certainly be processed by Sidekiq workers, even if there will be multiple Out Of Memory exceptions and the Sidekiq processes will be killed multiple times. Enabling it is as easy as enabling <code>super_fetch</code> in Sidekiq config. If you want to learn more about Sidekiq Pro Reliability Server, you can check <a href="https://github.com/mperham/sidekiq/wiki/Pro-Reliability-Server">the docs</a>.</p>

<p>What is more, Sidekiq Pro also brings some <a href="https://github.com/mperham/sidekiq/wiki/Pro-Reliability-Client">client reliability features</a>, although they are more limited. The scenario where it&rsquo;s supposed to help is when Redis is down. When calling <code>MyJob.perform_async</code>, we usually assume that things will just work. Sadly, it might sometimes happen that Redis will be down or there will be some network issue, and we will see a nasty 500 error. Sidekiq Pro tries to mitigate this problem by keeping the jobs locally and enqueuing them once the connection with Redis is reestablished. However, the queue where the jobs are stored is an in-memory one, and there is a limitation on how many jobs are stored there, so this solution is not perfect. If you don&rsquo;t find this solution reliable enough for your needs, you can establish a process for recovery from Redis outages, like storing the jobs in the database when rescuing from exceptions and enqueuing them later once Redis is back.</p>

<p>The only issue with Sidekiq Pro is that it&rsquo;s not that cheap. If you don&rsquo;t require strong guarantees and reliability, &ldquo;standard&rdquo; Sidekiq will probably be enough, but for processing business-critical jobs, Sidekiq Pro will be a great addition.</p>

<h2>Redis and its persistence modes</h2>

<p>Another scenario that can cause jobs to be lost is a crash or a restart of Redis process. To understand the potential consequences of these scenarios, we need to take a look at the persistence modes that are available.</p>

<p>Redis offers two strategies that can be used as standalone modes or be combined:</p>

<ol>
<li><strong>RDB</strong> (<strong>Redis Database Backup</strong>) &ndash; when using that mode, Redis will periodically create snapshots allowing point-in-time recovery. What it means is that if the snapshots are created every 5 minutes, you can lose the jobs from the maximum last 5 minutes. And in case of recovery, you might get some jobs that have been already processed within the last 5 minutes.</li>
<li><strong>AOF</strong> (<strong>Append Only File</strong>) &ndash; when using that mode, Redis will log all the operations using <code>fsync</code>. It can happen for every write operation, every 1 second or not at all.</li>
</ol>


<p>As you might have guessed, using <code>AOF</code> is necessary for reasonable durability. However, the exact config (i.e., whether <code>fsync</code> should happen every second or on every write) is highly dependent on the throughput and acceptable performance in your applications, since those operations add extra overhead. If the performance is good enough with <code>fsync</code> on every write, by all means go for that. But if the throughput suffers significantly, you might consider going with <code>fsync</code> every second and establishing a process of what to do if Redis goes down and some jobs are lost. This is again highly dependent on your applications and needs but usually logging jobs and what exactly gets enqueued is a good idea, including the name of the worker&rsquo;s class, its arguments, and timestamps. That way, you can predict which jobs might have been lost and enqueue them manually. You risk that some jobs might be processed more than once, so idempotency of the jobs would greatly help.</p>

<p>What about RDB? It would still be a good idea to have it enabled &ndash; <a href="https://redis.io/topics/persistence#ok-so-what-should-i-use">Redis&rsquo;s docs</a> recommend it in case there is a bug in the AOF engine, which sounds scary, but it&rsquo;s worth keeping in mind that durability is not the primary focus of Redis.</p>

<h2>Wrapping Up</h2>

<p>Even though getting started with <strong>Sidekiq</strong> is not rocket science, and it might initially seem like everything is fine, it won&rsquo;t be enough for an application processing business-critical backgrounds jobs. If you want to make sure you won&rsquo;t be <strong>losing jobs</strong>, you should consider buying <strong>Sidekiq Pro</strong> license and make sure <strong>Redis</strong> persistence is configured optimally (ideally, <strong>AOF</strong> persistence with <strong>fsync</strong> on every write).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/06/23/messages-on-rails-part-3-rabbitmq/">Messages on Rails Part 3: RabbitMQ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-06-23T18:00:00+02:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="https://karolgalanciak.com/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">first part</a> of this series, we were exploring some potential options for <strong>communication between services</strong> &ndash; what their advantages and disadvantages are, why <strong>HTTP API</strong> is not necessarily the best possible choice and suggesting that <strong>asynchronous messaging</strong> might be a better solution, using, e.g. <strong>RabbitMQ</strong> and <strong>Kafka</strong>. We&rsquo;ve already covered <strong>Kafka</strong> in the <a href="https://karolgalanciak.com/blog/2019/04/07/messages-on-rails-part-2-kafka/">part 2</a>, now it&rsquo;s the time for <strong>RabbitMQ</strong>.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2019/06/23/messages-on-rails-part-3-rabbitmq/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/07/messages-on-rails-part-2-kafka/">Messages on Rails Part 2: Kafka</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-04-07T20:00:00+02:00" pubdate data-updated="true">Apr 7<span>th</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="https://karolgalanciak.com/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">first part</a> of this series, we were exploring some potential options for <strong>communication between services</strong> &ndash; what their advantages and disadvantages are, why <strong>HTTP API</strong> is not necessarily the best possible choice and suggesting that <strong>asynchronous messaging</strong> might be a better solution, using, e.g. <strong>RabbitMQ</strong> and <strong>Kafka</strong>. Let&rsquo;s focus this time entirely on the latter.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2019/04/07/messages-on-rails-part-2-kafka/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">Messages on Rails Part 1 - Introduction to Kafka and RabbitMQ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-02-24T22:00:00+01:00" pubdate data-updated="true">Feb 24<span>th</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Microservices</strong>, <strong>Service-Oriented Architecture (SOA)</strong> and in general, <strong>distributed ecosystems</strong>, have been on hype in the last several years. And that&rsquo;s for a good reason! At certain point, The <strong>Majestic Monolith</strong> &ldquo;pattern&rdquo; might start causing issues, both from the purely technical reasons like scalability, tight coupling of the code if you don&rsquo;t follow <strong>Domain-Driven Design</strong> or some other practices <strong>improving modularity</strong>, maintenance overhead, and also from organizational perspective since working in smaller teams on smaller apps is more efficient than working with huge team on an even bigger monolith which suffers from tight coupling and low cohesion. However, this is only true if the overall architecture addresses the potential problems that are common in the micro/macro-services world. One of these problems I would like to focus on is communication between apps and how the data flows between them.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/01/27/how-to-tell-the-difference-between-a-default-and-provided-value-for-optional-arguments-in-ruby/">How to Tell the Difference Between a Default and a Provided Value for Optional Arguments in Ruby?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-01-27T20:00:00+01:00" pubdate data-updated="true">Jan 27<span>th</span>, 2019</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is sometimes required for the methods with optional arguments to be able to differentiate between its default value and the value passed from the caller. Passing <code>nil</code> might initially sound like a good idea since it represents &ldquo;nothingness&rdquo;. However, it might turn out that <code>nil</code> is a legit value and there might be cases where it is desirable for the caller to pass <code>nil</code>. In such a case, we cannot use it as a default value if we want to implement a special logic for the case of not providing that value.</p>

<p>Fortunately, there is an easy way to deal with it &ndash; use a special constant:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">SomeClass</span>
</span><span class='line'>  <span class="no">NO_VALUE_PROVIDED</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">private_constant</span> <span class="ss">:NO_VALUE_PROVIDED</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="ss">argument</span><span class="p">:</span> <span class="no">NO_VALUE_PROVIDED</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">argument</span> <span class="o">==</span> <span class="no">NO_VALUE_PROVIDED</span>
</span><span class='line'>      <span class="n">handle_scenario_for_no_value_provided</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">do_something_with_argument</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <code>call</code> method, we allow to pass an optional argument with a default of <code>NO_VALUE_PROVIDED</code>, which is a private constant defined in that class that is an instance of <code>Object</code>.</p>

<p>By depending on the instance of <code>Object</code> that is initialized inside that class, we can avoid cases where the equality check returns <code>true</code> even if this is not an expected outcome, which could happen if we used strings or symbols. We could use some symbol that would be very unlikely to be passed from the caller, like <code>:__no_value_provided__,</code> but it arguably looks more like a workaround than a dedicated solution for the problem.</p>

<p>Also, a private constant ensures it is not used anywhere outside the class, which minimizes the chances that the passed argument would the same as our placeholder for no-value-provided scenario even more.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/12/16/inheritance-and-define-method-how-to-make-them-work-together/">Inheritance and Define_method - How to Make Them Work Together</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-12-16T20:00:00+01:00" pubdate data-updated="true">Dec 16<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine that you are implementing some form object because you are fed up with treating ActiveRecord models as such, and you need some extra flexibility. You start with a straightforward implementation for a base class of a form object where you can just whitelist attributes. That could look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">FormObject</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attributes_registry</span>
</span><span class='line'>    <span class="vi">@attributes_registry</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attribute</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">attributes_registry</span> <span class="o">&lt;&lt;</span> <span class="n">attribute_name</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since the base class is ready, you can create a first form object that would inherit from this class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">MyForm</span> <span class="o">&lt;</span> <span class="no">FormObject</span>
</span><span class='line'>  <span class="n">attribute</span> <span class="ss">:some_attribute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Initially, it does the job, but then it turns out that you might need a default value if <code>some_attribute</code> turns out to be nil. So you try something like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">MyFormWithDefaultValue</span> <span class="o">&lt;</span> <span class="no">FormObject</span>
</span><span class='line'>  <span class="n">attribute</span> <span class="ss">:some_attribute</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">some_attribute</span>
</span><span class='line'>    <span class="k">super</span> <span class="o">||</span> <span class="s2">&quot;Default&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After checking if the default value works, this is what you get:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">&gt;</span> <span class="no">MyFormWithDefaultValue</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">some_attribute</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="ss">NoMethodError</span><span class="p">:</span> <span class="k">super</span><span class="p">:</span> <span class="n">no</span> <span class="n">superclass</span> <span class="nb">method</span> <span class="sb">`some_attribute&#39; for #&lt;MyFormWithDefaultValue:0x007f84a50ae8e0&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoops! How did it happen? The method was defined in the superclass so it should be inheritable, right?</p>

<p>Well, this is not really true. However, the problem is easy to fix.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2018/12/16/inheritance-and-define-method-how-to-make-them-work-together/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/09/30/the-problems-with-validating-activerecord-models-and-why-state-validation-is-a-bad-idea/">The Problems With Validating ActiveRecord Models and Why State Validation Is a Bad Idea</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-09-30T20:00:00+02:00" pubdate data-updated="true">Sep 30<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the typical <strong>Rails application</strong>, you can find the most of the validations in the <strong>ActiveRecord models</strong>, which is nothing surprising &ndash; ActiveRecord models are used for multiple things. Whether it is a good thing, or a bad thing (in most cases it&rsquo;s the latter) deserves a separate book or at least blog post-series as it&rsquo;s not a simple problem, there is one specific thing that can cause <strong>a lot of issues</strong> that are <strong>difficult to solve</strong> and go beyond <strong>design decisions</strong> and ease of maintenance of the application, something that impacts the behavior of the model &ndash; <strong>the validations</strong>.</p>

<p>Just to give you a real-world example of what validation in ActiveRecord model looks like (as impossible as it seems, it really did happen) &ndash; when updating the check-in time of the reservation, which is a simple attribute on Reservation model, the record turned out to be invalid because&hellip; the format of guest&rsquo;s phone didn&rsquo;t match some regexp.</p>

<p>There are multiple ways to bypass this problem: use <code>validate: false</code> flag with <code>save</code> method: <code>save(validate: false)</code> or use <code>update_columns</code> method, but this is definitely not something that can be applied in a &ldquo;normal&rdquo; use case. In a typical scenario, this will be the error message displayed in the UI/returned to API consumer, and it will be confusing.</p>

<p>However, this is the expected behavior of ActiveRecord (or in general, ActiveModel-style) validations, which is <strong>a validation of the state</strong> of the model. And judging from this example, it&rsquo;s evident that it leads to <strong>problematic scenarios</strong>. What kind of design then would be the most appropriate to <strong>prevent such issues</strong>?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2018/09/30/the-problems-with-validating-activerecord-models-and-why-state-validation-is-a-bad-idea/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/08/19/indexes-on-rails-how-to-make-the-most-of-your-postgres-database/">Indexes on Rails: How to Make the Most of Your Postgres Database</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-08-19T20:00:00+02:00" pubdate data-updated="true">Aug 19<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Optimizing <strong>database queries</strong> is arguably one of the fastest ways to improve the <strong>performance</strong> of the Rails applications. There are multiple ways how you can approach it, depending on the kind of a problem. <strong>N+1 queries</strong> seem to be a pretty common issue, which is, fortunately, <strong>easy to address</strong>. However, sometimes you have some relatively <strong>simple-looking queries</strong> that seem to take way longer than they should be, indicating that they might require some optimization. The best way to improve such queries is adding a <strong>proper index</strong>.</p>

<p>But what does &ldquo;proper index&rdquo; mean? How to figure out what kind of index is exactly needed for a given query? Here are some essential facts and tips that should cover a majority of the queries you may encounter and make your database no longer a bottleneck.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2018/08/19/indexes-on-rails-how-to-make-the-most-of-your-postgres-database/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/07/29/trolling-in-ruby-implementing-javascript-like-maths-with-implicit-conversion-hijacking/">Trolling in Ruby - Implementing JavaScript-like Maths With Implicit Conversion Hijacking</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-07-29T20:00:00+02:00" pubdate data-updated="true">Jul 29<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;ve ever worked with <strong>JavaScript</strong>, especially in <strong>pre-SPA/pre-frameworks</strong> era with just <strong>jQuery</strong>, you probably had a chance to see an &ldquo;exotic&rdquo; maths in action that looks similar to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;3&quot;</span> <span class="o">+</span> <span class="mi">4</span>
</span><span class='line'><span class="c1">// =&gt; &quot;34&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That kind of behavior usually comes as a <strong>big surprise</strong> and due to that fact, JavaScript has gotten some <strong>bad reputation</strong> (even though there is a <a href="https://karolgalanciak.com/blog/2017/01/22/javascript-the-surprising-parts/">rationale</a> behind it). If we tried that in <strong>Ruby</strong>, we would get an obvious <code>TypeError</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;3&quot;</span> <span class="o">+</span> <span class="mi">4</span>
</span><span class='line'><span class="c1"># =&gt; TypeError (no implicit conversion of Integer into String)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Would it be possible though to obtain the same result somehow in Ruby?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2018/07/29/trolling-in-ruby-implementing-javascript-like-maths-with-implicit-conversion-hijacking/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/24/rails-and-conditional-validations-in-models/">Rails and Conditional Validations in Models</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-24T20:00:00+02:00" pubdate data-updated="true">Jun 24<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Adding consents for accepting Terms of Service/Privacy Policies must have been a top popular feature in the majority of the applications due to enforcement of <strong>GDPR</strong> in May ;). From the technical aspects that GDPR requires, there is a proof of consent for processing the personal information. In that case, you need to have some actual attributes in the database that would confirm the fact that some user has indeed accepted Terms of Service/Privacy Policy.</p>

<p>That makes a significant impact on how we approach this kind of features. However, in the past, such things were quite often not stored in a database at all &ndash; it just took some UI <strong>acceptance validation</strong> or maybe a <strong>validation of the virtual attribute</strong> on the backend to be on the safe side.</p>

<p>Let&rsquo;s focus on the latter case where we don&rsquo;t need to store anything in DB and see what the possible solutions to that problems are. As <strong>trivial</strong> as this problem initially sounds, it will get <strong>quite interesting</strong> ;).</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2018/06/24/rails-and-conditional-validations-in-models/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <img class="left" src="/images/me_formal.jpg" title="me:)" alt="Karol Galanciak - photo">
  <p>Hi, I&#8217;m Karol Galanciak, I&#8217;m a distributed systems architect and a domain expert in vacation rental industry, taking it to the next level as CTO of <a href="https://www.bookingsync.com">BookingSync</a></p>

  <p>I specialize in distributed systems and microservices architecture, working with message queues, distributed streaming platforms, designing APIs and working with legacy applications.</p>

  <p id="email-me"></p>
</section>

<script type="text/javascript">
  (function(d, id, lhs, rhs) {
    d.getElementById(id).innerHTML = "You can reach me at <a rel='nofollow' href='mailto:" + lhs + "@" + rhs + "'>" + lhs + "@" + rhs + "</a>";
  })(window.document, 'email-me', 'karol.galanciak', 'gmail.com');
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/">Durable Sidekiq Jobs: How to Maximize Reliability of Sidekiq and Redis</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/23/messages-on-rails-part-3-rabbitmq/">Messages on Rails Part 3: RabbitMQ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/07/messages-on-rails-part-2-kafka/">Messages on Rails Part 2: Kafka</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">Messages on Rails Part 1 - Introduction to Kafka and RabbitMQ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/01/27/how-to-tell-the-difference-between-a-default-and-provided-value-for-optional-arguments-in-ruby/">How to Tell the Difference Between a Default and a Provided Value for Optional Arguments in Ruby?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/Azdaroth">@Azdaroth</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Azdaroth',
            count: 6,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
   <h1>Twitter</h1>
   <a class="twitter-timeline" href="https://twitter.com/Azdaroth" data-widget-id="357234540634329088">Tweets by @Azdaroth</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Karol Galanciak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'karolgalanciak';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
