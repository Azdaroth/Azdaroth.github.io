
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Durable Sidekiq jobs: how to maximize reliability of Sidekiq and Redis - Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert</title>
  <meta name="author" content="Karol Galanciak">

  
  <meta name="description" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">

  
  <meta name="keywords" content="Ruby on Rails, RabbitMQ, Kafka, Microservices, Distributed Systems, Architecture, Ember.js, PostgreSQL, JavaScript, Consulting, MVP, post MVP, legacy apps">

  
  

  <meta property="og:title" value="Durable Sidekiq jobs: how to maximize reliability of Sidekiq and Redis - Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" />
  <meta property="og:description" value="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" />
  <meta property="og:url" value="https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/" />
  <meta property="og:type" content="website" />
  
  <meta property="og:site_name" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert"/>
  <meta property="og:locale" content="en_US" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@Azdaroth">
  <meta name="twitter:creator" content="@Azdaroth">
  <meta name="twitter:title" content="Durable Sidekiq jobs: how to maximize reliability of Sidekiq and Redis - Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">
  <meta name="twitter:url" content="">
  <meta name="twitter:description" content="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert" type="application/atom+xml">
  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type":"WebPage",
        "@id": "https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis"
      },
      "headline": "Durable Sidekiq jobs: how to maximize reliability of Sidekiq and Redis - Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert",
        "image": {
        "@type": "ImageObject",
        "url": "",
        "height": 640,
        "width": 1024
      },
      "datePublished": "2019-08-18",
      "dateModified": "2019-09-08",
      "author": {
        "@type": "Person",
        "name": "Karol Galanciak"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Karol Galanciak",
        "logo": {
          "@type": "ImageObject",
          "url": "https://karolgalanciak.com/images/me_formal.jpg",
          "width": 600,
          "height": 60
        }
      },
      "description": "Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert",
      "keywords": "Ruby on Rails, RabbitMQ, Kafka, Microservices, Distributed Systems, Architecture, Ember.js, PostgreSQL, JavaScript, Consulting, MVP, post MVP, legacy apps"
    }
  </script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42570582-1', 'auto');
    ga('send', 'pageview');
    ga('set', 'anonymizeIp', true);
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Karol Galanciak - Distributed Systems Architect and Ruby on Rails expert</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:karolgalanciak.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">About Me</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/test-driven-ember">Test-Driven Ember Book</a></li>
  <li><a href="/presentations">Presentations</a></li>
  <li><a href="/publications">Publications</a></li>
  <li><a href="/open-source">Open Source</a></li>
  <li><a href="/privacy-policy">Privacy Policy</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Durable Sidekiq Jobs: How to Maximize Reliability of Sidekiq and Redis</h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-08-18T20:00:00+02:00" pubdate data-updated="true">Aug 18<span>th</span>, 2019</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>Sidekiq</strong> is one of the most popular (if not the most popular one) background job framework in Ruby world, which is not a big surprise: it allows to achieve a decent throughput, is stable and well-maintained, has some great features (including also all the gems extending its built-in functionality) and is easy to get started with. It seems like you could simply install <strong>Redis</strong>, add <strong>Sidekiq</strong> to your application and you are good to go!</p>

<p>That would work if you didn&rsquo;t have any <strong>business-critical background jobs</strong> where <strong>reliability</strong> doesn&rsquo;t matter that much. However, if you cannot afford to <strong>lose jobs</strong> every now and then, there are some things that are absolutely critical to review in your configuration and infrastructure.</p>

<h2>How can you lose a Sidekiq job?</h2>

<p>There are multiple scenarios of how you can lose a Sidekiq job without preventive measures. Some of them are quite obvious; some of them are not.</p>

<p>One obvious way would be having Redis down and trying to enqueue a job. This one is pretty intuitive as there is no way of pushing something to Redis if there is no connection to Redis in the first place. From the less obvious scenarios, what is going to happen when Redis crashes while processing a job, due to, e.g., Out Of Memory exception? In &ldquo;standard&rdquo; Sidekiq (although not in Sidekiq Pro), processing a job means that the data is dequeued from Redis and if the worker is interrupted and killed, the job will be lost.</p>

<p>To make the matter worse, there are even more ways how to lose jobs. Imagine that Redis has been working just fine so far, there are some jobs enqueued to be processed in the future, nothing is getting processed at the moment and&hellip; the server gets restarted. Depending on your setup and how much data is stored in memory before it gets &ldquo;persisted&rdquo;, it might turn out that all (or at least some of them) the enqueued jobs are lost!</p>

<p>As terrible as it sounds, there are some relatively quick fixes to these problems. Even though it might be still possible to lose jobs under <a href="https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781783280216/1/ch01lvl1sec16/dealing-with-aof-corruption-intermediate">extreme circumstances</a>, these solutions will significantly minimize the likelihood of critical problems.</p>

<h2>Sidekiq Pro and its reliability features</h2>

<p>The very first thing that would be worth doing would be buying a license for <a href="https://sidekiq.org/products/pro.html">Sidekiq Pro</a> which is a low hanging-fruit, and you can quickly add it to your applications.</p>

<p>Sidekiq Pro, unlike &ldquo;standard&rdquo; Sidekiq, offers extra server reliability by using <a href="https://redis.io/commands/rpoplpush">Redis&rsquo;s RPOPLPUSH</a>. Thanks to that, the job is not entirely removed from Redis once it starts being processed. Rather, it is atomically moved to &ldquo;processing list&rdquo; and is removed from there only after it&rsquo;s processed. In that sense, we can be confident that if the job ended up in Redis, it would almost certainly be processed by Sidekiq workers, even if there will be multiple Out Of Memory exceptions and the Sidekiq processes will be killed multiple times. Enabling it is as easy as enabling <code>super_fetch</code> in Sidekiq config. If you want to learn more about Sidekiq Pro Reliability Server, you can check <a href="https://github.com/mperham/sidekiq/wiki/Pro-Reliability-Server">the docs</a>.</p>

<p>What is more, Sidekiq Pro also brings some <a href="https://github.com/mperham/sidekiq/wiki/Pro-Reliability-Client">client reliability features</a>, although they are more limited. The scenario where it&rsquo;s supposed to help is when Redis is down. When calling <code>MyJob.perform_async</code>, we usually assume that things will just work. Sadly, it might sometimes happen that Redis will be down or there will be some network issue, and we will see a nasty 500 error. Sidekiq Pro tries to mitigate this problem by keeping the jobs locally and enqueuing them once the connection with Redis is reestablished. However, the queue where the jobs are stored is an in-memory one, and there is a limitation on how many jobs are stored there, so this solution is not perfect. If you don&rsquo;t find this solution reliable enough for your needs, you can establish a process for recovery from Redis outages, like storing the jobs in the database when rescuing from exceptions and enqueuing them later once Redis is back.</p>

<p>The only issue with Sidekiq Pro is that it&rsquo;s not that cheap. If you don&rsquo;t require strong guarantees and reliability, &ldquo;standard&rdquo; Sidekiq will probably be enough, but for processing business-critical jobs, Sidekiq Pro will be a great addition.</p>

<h2>Redis and its persistence modes</h2>

<p>Another scenario that can cause jobs to be lost is a crash or a restart of Redis process. To understand the potential consequences of these scenarios, we need to take a look at the persistence modes that are available.</p>

<p>Redis offers two strategies that can be used as standalone modes or be combined:</p>

<ol>
<li><strong>RDB</strong> (<strong>Redis Database Backup</strong>) &ndash; when using that mode, Redis will periodically create snapshots allowing point-in-time recovery. What it means is that if the snapshots are created every 5 minutes, you can lose the jobs from the maximum last 5 minutes. And in case of recovery, you might get some jobs that have been already processed within the last 5 minutes.</li>
<li><strong>AOF</strong> (<strong>Append Only File</strong>) &ndash; when using that mode, Redis will log all the operations using <code>fsync</code>. It can happen for every write operation, every 1 second or not at all.</li>
</ol>


<p>As you might have guessed, using <code>AOF</code> is necessary for reasonable durability. However, the exact config (i.e., whether <code>fsync</code> should happen every second or on every write) is highly dependent on the throughput and acceptable performance in your applications, since those operations add extra overhead. If the performance is good enough with <code>fsync</code> on every write, by all means go for that. But if the throughput suffers significantly, you might consider going with <code>fsync</code> every second and establishing a process of what to do if Redis goes down and some jobs are lost. This is again highly dependent on your applications and needs but usually logging jobs and what exactly gets enqueued is a good idea, including the name of the worker&rsquo;s class, its arguments, and timestamps. That way, you can predict which jobs might have been lost and enqueue them manually. You risk that some jobs might be processed more than once, so idempotency of the jobs would greatly help.</p>

<p>What about RDB? It would still be a good idea to have it enabled &ndash; <a href="https://redis.io/topics/persistence#ok-so-what-should-i-use">Redis&rsquo;s docs</a> recommend it in case there is a bug in the AOF engine, which sounds scary, but it&rsquo;s worth keeping in mind that durability is not the primary focus of Redis.</p>

<h2>Wrapping Up</h2>

<p>Even though getting started with <strong>Sidekiq</strong> is not rocket science, and it might initially seem like everything is fine, it won&rsquo;t be enough for an application processing business-critical backgrounds jobs. If you want to make sure you won&rsquo;t be <strong>losing jobs</strong>, you should consider buying <strong>Sidekiq Pro</strong> license and make sure <strong>Redis</strong> persistence is configured optimally (ideally, <strong>AOF</strong> persistence with <strong>fsync</strong> on every write).</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Karol Galanciak</span></span>

      








  


<time datetime="2019-08-18T20:00:00+02:00" pubdate data-updated="true">Aug 18<span>th</span>, 2019</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/redis/'>Redis</a>, <a class='category' href='/blog/categories/sidekiq/'>Sidekiq</a>
  
</span>


    </p>
    <div class="meta top-line">
      <div class="post-subscription">
  <div id="mc_embed_signup">
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">Do you want to take your developer skills to the next level? Subscribe to my newsletter and never miss another blog post!</label>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_62804f1b69c60e0c7966cddd6_7c71fb81df" tabindex="-1" value=""></div>
      <div class="clear">
      <a href="http://eepurl.com/duztq5" target="_blank" id="mc-embedded-subscribe" class="button">Yes, I want to be a better developer!</a>
    </div>
  </div>
</div>

    </div>
    <div class="top-line">
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/" data-via="Azdaroth" data-counturl="https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

      
    </div>
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/06/23/messages-on-rails-part-3-rabbitmq/" title="Previous Post: Messages on Rails Part 3: RabbitMQ">&laquo; Messages on Rails Part 3: RabbitMQ</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <img class="left" src="/images/me_formal.jpg" title="me:)" alt="Karol Galanciak - photo">
  <p>Hi, I'm Karol Galanciak, I'm a distributed systems architect and a domain expert in vacation rental industry, taking it to the next level as CTO of <a href="https://www.bookingsync.com">BookingSync</a></p>

  <p>I specialize in distributed systems and microservices architecture, working with message queues, distributed streaming platforms, designing APIs and working with legacy applications.</p>

  <p id="email-me"></p>
</section>

<script type="text/javascript">
  (function(d, id, lhs, rhs) {
    d.getElementById(id).innerHTML = "You can reach me at <a rel='nofollow' href='mailto:" + lhs + "@" + rhs + "'>" + lhs + "@" + rhs + "</a>";
  })(window.document, 'email-me', 'karol.galanciak', 'gmail.com');
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/">Durable Sidekiq Jobs: How to Maximize Reliability of Sidekiq and Redis</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/23/messages-on-rails-part-3-rabbitmq/">Messages on Rails Part 3: RabbitMQ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/07/messages-on-rails-part-2-kafka/">Messages on Rails Part 2: Kafka</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/02/24/messages-on-rails-part-1-introduction-to-kafka-and-rabbitmq/">Messages on Rails Part 1 - Introduction to Kafka and RabbitMQ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/01/27/how-to-tell-the-difference-between-a-default-and-provided-value-for-optional-arguments-in-ruby/">How to Tell the Difference Between a Default and a Provided Value for Optional Arguments in Ruby?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/Azdaroth">@Azdaroth</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Azdaroth',
            count: 6,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
   <h1>Twitter</h1>
   <a class="twitter-timeline" href="https://twitter.com/Azdaroth" data-widget-id="357234540634329088">Tweets by @Azdaroth</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Karol Galanciak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'karolgalanciak';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/';
        var disqus_url = 'https://karolgalanciak.com/blog/2019/08/18/durable-sidekiq-jobs-how-to-maximize-reliability-of-sidekiq-and-redis/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
